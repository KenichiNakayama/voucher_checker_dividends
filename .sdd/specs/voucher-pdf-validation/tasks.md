# 実装タスクリスト

## セクション1：データモデル実装
- [x] 1.1 必要な型定義・データ構造を作成する
  - `voucher_logic/models.py` に `ParsedDocument`、`ExtractedVoucherData`、`ValidationReport`、`VoucherAnalysisResult`、`ProviderType` など design.md で定義されたモデルを実装する
  - フィールドの型変換・必須項目チェック等、基本的なバリデーションルールを実装する
- [x] 1.2 データ永続化層を実装する
  - 今回は永続ストレージを使用しないため、セッション内メモリ保持ポリシーと破棄処理を `VoucherAnalysisResult` 利用箇所で整理する
  - 将来の永続化拡張に備えてインターフェース（ダミークラス）を用意する

## セクション2：ビジネスロジック実装
- [x] 2.1 Voucher解析コントローラを実装する
  - `voucher_logic/controller.py` に処理フロー1-3を担当する `analyze_voucher` 関数を実装し、PDF読み込み結果を統合する
  - PDF読み込み失敗時の例外処理を盛り込み、UIへ返すエラー表示を構築する
- [x] 2.2 抽出・検証・ハイライト処理を実装する
  - `voucher_logic/extraction.py` にAIプロンプト生成とレスポンスパース（処理フロー4-5）を実装する
  - `voucher_logic/validators.py` に要件検証ロジック（処理フロー6）を実装し、欠落時メッセージを定義する
  - `voucher_logic/highlight.py` にハイライトPDF生成処理（処理フロー7）を実装し、プレビューやダウンロード用バイト列を返す
- [x] 2.3 エラーハンドリングを実装する
  - APIキー未設定、AIレスポンス不正、ハイライト生成失敗など設計書で挙げたエラーケースを例外として整理し、`controller` で捕捉する
  - 利用者向けメッセージとログ向け詳細情報を分離する

## セクション3：インターフェース実装
- [x] 3.1 UIコンポーネントを実装する
  - `app.py` にファイルアップロードUI、APIプロバイダ選択、解析実行ボタン、結果表示コンポーネント、ハイライトPDFダウンロードボタンを追加する
- [x] 3.2 入力バリデーションを実装する
  - アップロードファイルの拡張子・サイズチェックやAPIキー設定確認をUIで行い、問題があれば処理前に警告を表示する
- [x] 3.3 出力フォーマットを実装する
  - 検証結果テーブル、抽出情報一覧、ハイライトプレビュー（可能なら画像）、ダウンロードリンクを見やすく配置する
  - エラー発生時はアラートコンポーネントで対応する

## セクション4：統合とテスト
- [x] 4.1 コンポーネントを統合する
  - `app.py` と `voucher_logic/` 下のモジュールを接続し、データモデル間のやり取りを確認する
  - プロバイダ選択によってOpenAI/Claudeクライアントが切り替わることを検証する
- [x] 4.2 基本的な動作テストを実装する
  - `tests/` 以下にユニットテストを追加し、`validators` や `controller` の主要分岐をカバーする
  - LLM呼び出しはモック化し、ハイライト生成のエラーケースなども検証する
- [ ] 4.3 要件の受入基準を満たすことを確認する
  - 要件1〜6について、UI表示とバックエンド処理が満たされることを手動/自動テストで確認し、必要に応じてドキュメント化する
  - `pytest` コマンドが環境に無く自動テスト未実行。`pip install pytest` 後に `pytest` を実行して検証すること。
